# Kubernetes Operator Release Pipeline
#
# This workflow automates the release process for Kubernetes operators including:
# - Semantic versioning
# - Release artifact generation
# - Homebrew formula update (optional)
# - Helm chart release (optional)
#
# Usage: Copy to .github/workflows/release.yml in your operator project

name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write
  id-token: write

env:
  GO_VERSION: '1.21'
  IMAGE_REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # -------------------------------------------------------------------------
  # Job 1: Create Release
  # -------------------------------------------------------------------------
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.release.outputs.upload_url }}
      version: ${{ steps.tag.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: tag
        run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          # Generate changelog
          if [ -z "$PREV_TAG" ]; then
            git log --pretty=format:"- %s (%h)" > changelog.md
          else
            git log --pretty=format:"- %s (%h)" ${PREV_TAG}..HEAD > changelog.md
          fi

          # Add header
          cat > RELEASE_NOTES.md << EOF
          ## Release ${{ steps.tag.outputs.version }}

          ### Changes
          $(cat changelog.md)

          ### Installation
          \`\`\`bash
          kubectl apply -f https://github.com/${{ github.repository }}/releases/download/${{ steps.tag.outputs.version }}/manifests.yaml
          \`\`\`

          ### Image
          \`\`\`
          ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.version }}
          \`\`\`
          EOF

      - name: Create Release
        id: release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ steps.tag.outputs.version }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: ${{ contains(steps.tag.outputs.version, 'rc') || contains(steps.tag.outputs.version, 'alpha') || contains(steps.tag.outputs.version, 'beta') }}

  # -------------------------------------------------------------------------
  # Job 2: Build and Push Release Images
  # -------------------------------------------------------------------------
  build-images:
    name: Build Release Images
    runs-on: ubuntu-latest
    needs: create-release
    strategy:
      matrix:
        platform:
          - linux/amd64
          - linux/arm64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.IMAGE_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: ${{ matrix.platform }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          provenance: true
          sbom: true
          annotations: ${{ steps.meta.outputs.annotations }}

  # -------------------------------------------------------------------------
  # Job 3: Generate and Upload Artifacts
  # -------------------------------------------------------------------------
  artifacts:
    name: Generate Release Artifacts
    runs-on: ubuntu-latest
    needs: create-release
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Download dependencies
        run: go mod download

      - name: Install tools
        run: |
          go install sigs.k8s.io/controller-tools/cmd/controller-gen@v0.14.0
          go install sigs.k8s.io/kustomize/kustomize/v5@latest
          echo "$GOPATH/bin" >> $GITHUB_PATH

      - name: Generate manifests
        run: make manifests

      - name: Build manifests.yaml
        run: |
          kustomize build config/crd > manifests.yaml
          echo "Generated manifests.yaml"

      - name: Build bundle.yaml
        run: |
          kustomize build config/default > bundle.yaml
          echo "Generated bundle.yaml"

      - name: Upload manifests.yaml
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./manifests.yaml
          asset_name: manifests.yaml
          content_type: application/yaml

      - name: Upload bundle.yaml
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: ./bundle.yaml
          asset_name: bundle.yaml
          content_type: application/yaml

  # -------------------------------------------------------------------------
  # Job 4: Generate Helm Chart (Optional)
  # -------------------------------------------------------------------------
  helm-chart:
    name: Package Helm Chart
    runs-on: ubuntu-latest
    needs: create-release
    if: hashFiles('helm/**') != ''
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Package Helm chart
        run: |
          cd helm
          helm package .

      - name: Upload Helm chart
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: helm/*.tgz
          asset_name: helm-chart-${{ needs.create-release.outputs.version }}.tgz
          content_type: application/gzip

  # -------------------------------------------------------------------------
  # Job 5: Publish to Homebrew (Optional)
  # -------------------------------------------------------------------------
  homebrew:
    name: Update Homebrew Tap
    runs-on: ubuntu-latest
    needs: [build-images, artifacts]
    if: github.repository == 'your-org/your-project'  # Replace with your repo
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update Homebrew formula
        run: |
          # This is an example - you need to customize for your setup
          # Create a homebrew tap repository and update the formula
          echo "Updating Homebrew formula for ${{ needs.create-release.outputs.version }}"
          # Example: curl -X POST https://your-homebrew-tap/update ...

  # -------------------------------------------------------------------------
  # Job 6: Publish Helm Chart to OCI Registry
  # -------------------------------------------------------------------------
  helm-oci:
    name: Publish Helm Chart to OCI
    runs-on: ubuntu-latest
    needs: [helm-chart, build-images]
    if: hashFiles('helm/**') != ''
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Log in to OCI registry
        run: |
          echo ${{ secrets.GITHUB_TOKEN }} | helm registry login ${{ env.IMAGE_REGISTRY }} --username ${{ github.actor }} --password-stdin

      - name: Package and push Helm chart
        run: |
          cd helm
          CHART_VERSION=${{ needs.create-release.outputs.version }}
          helm package . --version $CHART_VERSION
          helm push *.tgz oci://${{ env.IMAGE_REGISTRY }}/helm-charts
